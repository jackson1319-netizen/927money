<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…æ¯å°é‡‘åº«å°ˆæ¡ˆ v4.9 (è¦–è¦ºçµ±ä¸€ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        ::-webkit-scrollbar { display: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 15px;
            background-color: #f4f6f8;
            color: #333;
            -ms-overflow-style: none; scrollbar-width: none;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1a3c5e; /* æ·±æµ·è»è— */
            --accent-color: #c5a065;  /* é¦™æª³é‡‘ */
            --bg-light: #ffffff;
            --bg-offset: #f8f9fa;
            --text-dark: #2c3e50;
            --text-gray: #7f8c8d;
            --border-radius: 12px;
            --input-bg: #eef2f5;
            --success-green: #27ae60;
            --alert-red: #c0392b; 
        }

        /* --- ç™»å…¥é®ç½© --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f4f6f8; z-index: 9999; display: flex;
            align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .login-card {
            background: white; padding: 40px; border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; width: 320px;
            border-top: 5px solid var(--primary-color);
        }
        .login-title { color: var(--primary-color); font-size: 22px; font-weight: 700; margin-bottom: 25px; letter-spacing: 1px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #dcdfe6; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary-color); outline: none; }
        .login-btn { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600; letter-spacing: 1px; transition: 0.3s; }
        .login-btn:hover { background-color: #132c45; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26, 60, 94, 0.2); }
        .error-msg { color: var(--alert-red); font-size: 14px; margin-top: 15px; display: none; }

        /* --- ä¸»å®¹å™¨ --- */
        .container {
            width: 100%; max-width: 1000px;
            background: var(--bg-light);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin: 0 auto;
        }

        /* --- Header --- */
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        h2 { font-weight: 700; font-size: 1.8rem; margin: 0 0 8px 0; color: var(--primary-color); }
        .subtitle { font-size: 0.95rem; color: var(--text-gray); font-weight: 400; letter-spacing: 1px; }

        /* --- Banner --- */
        .banner-container { width: 100%; margin-bottom: 25px; border-radius: var(--border-radius); overflow: hidden; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .banner-img { width: 100%; height: auto; display: block; }

        /* --- æ§åˆ¶é …èˆ‡è¼¸å…¥æ¡† --- */
        .currency-toggle-wrapper {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 25px; padding: 8px 20px;
            background: var(--bg-offset); border-radius: 50px;
            width: fit-content; margin-left: auto; margin-right: auto;
            border: 1px solid #e0e0e0;
        }
        .rate-info { font-size: 0.85rem; color: var(--text-gray); margin-right: 15px; font-family: monospace; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e0; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .currency-label { font-size: 0.9rem; font-weight: 700; margin-left: 12px; color: var(--text-dark); }

        h3.section-title {
            font-size: 0.9rem; font-weight: 700; color: var(--primary-color);
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-top: 35px; margin-bottom: 20px; padding-left: 12px;
            border-left: 4px solid var(--accent-color);
        }

        .input-group { margin-bottom: 25px; text-align: center; }
        label { display: block; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600; color: var(--text-dark); }
        
        input.base-input {
            width: 100%; padding: 16px; border-radius: 12px; border: 2px solid transparent;
            background-color: var(--input-bg); font-size: 1.5rem; font-weight: 600;
            text-align: center; color: var(--primary-color); outline: none; transition: 0.3s;
        }
        input.base-input:focus { background-color: #fff; border-color: var(--accent-color); box-shadow: 0 0 10px rgba(197, 160, 101, 0.2); }

        .stepper-container {
            display: flex; align-items: center; justify-content: center;
            background-color: var(--input-bg); border-radius: 12px; padding: 6px;
        }
        .stepper-btn {
            width: 50px; height: 50px; border: none; background: transparent;
            font-size: 1.8rem; color: var(--primary-color); cursor: pointer;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .stepper-btn:hover { background-color: rgba(26, 60, 94, 0.1); }
        .stepper-input {
            flex: 1; border: none; background: transparent; text-align: center;
            font-size: 1.5rem; font-weight: 600; color: var(--primary-color); outline: none;
            width: 80px; -moz-appearance: textfield;
        }
        .stepper-input::-webkit-outer-spin-button, 
        .stepper-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .premium-input-style { background-color: #fffbf2; border: 1px solid #faecc9; }
        .premium-input-style.manual-mode { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(197, 160, 101, 0.1); }
        .premium-input-style .stepper-input { color: #8a6d3b; }
        .premium-input-style .stepper-btn { color: #8a6d3b; }

        .reset-auto-btn {
            display: none; font-size: 0.8rem; color: var(--primary-color);
            background: none; border: 1px solid var(--primary-color);
            padding: 6px 14px; border-radius: 20px; cursor: pointer;
            margin: 10px auto 0 auto; transition: 0.3s;
        }
        .reset-auto-btn:hover { background-color: var(--primary-color); color: white; }

        button.action-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c5279 100%);
            color: white; padding: 18px; border: none; border-radius: 12px; 
            font-size: 1.1rem; font-weight: 600; width: 100%; cursor: pointer; 
            box-shadow: 0 8px 20px rgba(26, 60, 94, 0.25);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px; letter-spacing: 1px;
        }
        button.action-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(26, 60, 94, 0.35); }
        button.action-btn:active { transform: translateY(0); }

        /* --- çµæœå¡ç‰‡ --- */
        .result-box { margin-top: 25px; }
        .result-row { display: flex; justify-content: space-between; align-items: baseline; padding: 14px 0; font-size: 1rem; border-bottom: 1px solid #eee; }
        .result-row:last-child { border-bottom: none; }
        .result-label { color: var(--text-gray); font-weight: 500; }
        .result-value { font-weight: 700; color: var(--text-dark); font-feature-settings: "tnum"; font-family: "SF Mono", "Roboto Mono", monospace; }
        .highlight-blue { color: var(--primary-color); }
        
        .highlight-total-card {
            margin-top: 30px; padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #102a43 100%);
            color: white; border-radius: 16px; text-align: center;
            box-shadow: 0 10px 30px rgba(26, 60, 94, 0.3);
            position: relative; overflow: hidden;
        }
        .highlight-total-card::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
            transform: rotate(30deg);
        }
        .highlight-total-card .result-label { display: block; margin-bottom: 8px; color: rgba(255,255,255,0.7); font-size: 0.9rem; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
        .highlight-total-card .result-value { font-size: 2.2rem; color: #fff; letter-spacing: -0.5px; font-weight: 700; }

        .status-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-success { background-color: rgba(39, 174, 96, 0.15); color: var(--success-green); }
        .status-error { background-color: rgba(192, 57, 43, 0.15); color: var(--alert-red); }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        .table-container {
            margin-top: 40px; overflow-x: auto; border-radius: 12px;
            border: 1px solid #e1e4e8; background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        table {
            width: 100%; border-collapse: collapse; font-size: 0.85rem;
            text-align: center; min-width: 950px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        thead { background-color: var(--primary-color); color: white; }
        th {
            padding: 15px 8px; font-weight: 600; letter-spacing: 0.5px;
            border-right: 1px solid rgba(255,255,255,0.1); white-space: nowrap; vertical-align: middle;
        }
        th:last-child { border-right: none; }
        .th-small { display: block; font-size: 0.7em; opacity: 0.8; font-weight: 400; margin-top: 4px; }
        
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #f1f4f6; }
        td {
            padding: 12px 8px; border-bottom: 1px solid #eee; color: var(--text-dark);
            font-feature-settings: "tnum"; white-space: nowrap; vertical-align: middle;
            font-family: "SF Mono", "Roboto Mono", monospace; 
        }
        tr:last-child td { border-bottom: none; }

        /* è¡¨æ ¼å…§æ•¸å€¼é¡è‰² */
        .val-surrender { color: #d35400; font-weight: 600; } /* è§£ç´„é‡‘ç¶­æŒæ©˜ç´… */
        .val-invest-payout { color: var(--text-gray); } 
        .val-invest-payout.cashflow-highlight { color: var(--alert-red); font-weight: 700; }
        
        /* ç¸½è³‡ç”¢èˆ‡ ROI */
        .val-total { color: var(--primary-color); font-weight: 700; } 
        .col-roi { color: var(--alert-red); font-weight: 800; font-size: 1.05em; } 

        .cashflow-label { font-size: 0.7em; color: var(--alert-red); display: block; line-height: 1; margin-top: 2px; }
        
        /* å…è²¬è²æ˜æ¨£å¼ */
        .disclaimer-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e4e8;
            margin-top: 30px;
        }
        .disclaimer-title {
            color: var(--alert-red);
            font-weight: 700;
            margin-bottom: 12px;
            display: block;
            font-size: 0.9rem;
        }
        .disclaimer-list {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin: 0;
            padding-left: 20px;
            line-height: 1.6;
            text-align: left;
        }
        .disclaimer-list li { margin-bottom: 5px; }

    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div class="login-title">ğŸ”’ ç³»çµ±å­˜å–æ¬Šé™</div>
        <input type="password" id="passwordInput" class="login-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼..." onkeyup="if(event.keyCode===13) checkPassword()">
        <button class="login-btn" onclick="checkPassword()">ç¢ºèªè§£é–</button>
        <div id="errorMsg" class="error-msg">âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</div>
    </div>
</div>

<div class="container">
    
    <div class="banner-container" id="bannerContainer">
        <img src="" alt="Banner" class="banner-img" id="bannerImg">
    </div>

    <header>
        <h2>é…æ¯å°é‡‘åº«å°ˆæ¡ˆ</h2>
        <div class="subtitle">å¯Œé‚¦å°ˆå±¬è³‡ç”¢é…ç½®ç³»çµ± (è¦–è¦ºå„ªåŒ–ç‰ˆ)</div>
    </header>

    <div class="currency-toggle-wrapper">
        <span class="rate-info">åŒ¯ç‡åƒè€ƒ: 31.32</span>
        <label class="switch">
            <input type="checkbox" id="currencyToggle" onchange="toggleCurrency()">
            <span class="slider"></span>
        </label>
        <span class="currency-label" id="currencyText">TWD</span>
    </div>
    
    <div class="input-group">
        <label for="clientAge">è¼¸å…¥ä¿æˆ¶å¹´é½¡ (æ­²)</label>
        <input type="number" id="clientAge" value="36" min="0" max="100" class="base-input" placeholder="ä¾‹å¦‚ï¼š36">
    </div>

    <div class="input-group">
        <label id="inputLabel" for="principal">è¼¸å…¥ç¸½è³‡é‡‘è¦æ¨¡ (NT$)</label>
        <input type="number" id="principal" value="10000000" min="0" step="10000" class="base-input" placeholder="ä¾‹å¦‚ï¼š10000000" onchange="handlePrincipalChange()">
    </div>

    <div class="input-group">
        <label for="payoutRate">é æœŸå¹´åŒ–é…æ¯ç‡ (%)</label>
        <div class="stepper-container">
            <button class="stepper-btn" onclick="adjustValue('payoutRate', -0.5)">âˆ’</button>
            <input type="number" id="payoutRate" value="8" min="0" step="0.1" class="stepper-input" onchange="handleParamChange()">
            <button class="stepper-btn" onclick="adjustValue('payoutRate', 0.5)">+</button>
        </div>
    </div>

    <div class="input-group">
        <label for="feeRate">é©ç”¨æ‰‹çºŒè²»ç‡ (%)</label>
        <div class="stepper-container">
            <button class="stepper-btn" onclick="adjustValue('feeRate', -1)">âˆ’</button>
            <input type="number" id="feeRate" value="2" min="0" max="10" step="1" class="stepper-input" onchange="handleParamChange()">
            <button class="stepper-btn" onclick="adjustValue('feeRate', 1)">+</button>
        </div>
    </div>

    <div class="input-group">
        <label for="manualPremium">åˆ†ç´…ä¿å–®å¹´ç¹³ä¿è²» (ç³»çµ±è‡ªå‹•è©¦ç®—)</label>
        <div class="stepper-container premium-input-style" id="premiumContainer">
            <button class="stepper-btn" onclick="adjustPremium(-10000)">âˆ’</button>
            <input type="number" id="manualPremium" value="0" min="0" step="1000" class="stepper-input" onchange="enableManualMode()">
            <button class="stepper-btn" onclick="adjustPremium(10000)">+</button>
        </div>
        <button class="reset-auto-btn" id="resetAutoBtn" onclick="restoreAutoMode()">â†º æ¢å¾©è‡ªå‹•å¹³è¡¡è¨ˆç®—</button>
        <div style="font-size:0.75rem; color:#8a6d3b; margin-top:5px;" id="premiumHint">* èª¿æ•´æ­¤é‡‘é¡å°‡æ”¹è®ŠæŠ•è³‡é…ç½®</div>
    </div>
    
    <button class="action-btn" onclick="calculatePlan()">æ›´æ–°è³‡ç”¢è©¦ç®—è¡¨</button>

    <div class="result-box" id="results">
        </div>
    
    <div id="projectionArea" style="display:none;">
        <h3 class="section-title">20å¹´è³‡ç”¢å¢é•·èˆ‡å‚™ç”¨é‡‘é ä¼°</h3>
        <div class="table-container">
            <table id="projectionTable">
                <thead>
                    <tr>
                        <th width="8%">å¹´åº¦</th>
                        <th width="8%">å¹´é½¡</th>
                        <th>åˆ†ç´…ä¿å–®<br>è§£ç´„é‡‘</th>
                        <th>ç•¶å¹´åº¦<br>æŠ•è³‡é…æ¯</th>
                        <th>æŠ•è³‡å¸³æˆ¶<br>æœ¬é‡‘çµé¤˜<span class="th-small">(å‡è¨­æ·¨å€¼ä¸è®Š)</span></th>
                        <th>æŠ•è³‡å‹<br>å‚™ç”¨é‡‘<span class="th-small">(æœ¬é‡‘50%)</span></th>
                        <th>åˆ†ç´…ä¿å–®<br>å‚™ç”¨é‡‘<span class="th-small">(å€Ÿæ¬¾ä¸Šé™)</span></th>
                        <th>ç¸½è³‡ç”¢<br><span class="th-small">(å«è§£ç´„+æ·¨ç¾é‡‘æµ)</span></th>
                        <th>ç¸½è³‡ç”¢<br>å ±é…¬ç‡</th>
                    </tr>
                </thead>
                <tbody id="projectionBody">
                </tbody>
            </table>
        </div>

        <div class="disclaimer-box">
            <span class="disclaimer-title">âš ï¸ å…è²¬è²æ˜ï¼šæœ¬è¨ˆç®—æ©Ÿåƒ…ä¾›å…§éƒ¨æ•™è‚²è¨“ç·´èˆ‡æ¨¡æ“¬è©¦ç®—ä½¿ç”¨ï¼Œä¸¦éæ­£å¼ä¿å–®æ¢æ¬¾æˆ–éŠ·å”®æ–‡ä»¶ã€‚</span>
            <ol class="disclaimer-list">
                <li>æ‰€æœ‰è©¦ç®—æ•¸æ“šï¼ˆå¦‚å®£å‘Šåˆ©ç‡ã€æŠ•è³‡å ±é…¬ç‡ 7% ç­‰ï¼‰å‡ç‚ºå‡è¨­å€¼ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸ä»£è¡¨æœªä¾†å¯¦éš›ç¸¾æ•ˆï¼Œäº¦ä¸ä¿è­‰æœ€ä½æ”¶ç›Šã€‚</li>
                <li>å¯¦éš›ä¿å–®æ¬Šåˆ©ç¾©å‹™è«‹ä»¥ä¿éšªå…¬å¸æ­£å¼æ¢æ¬¾ç‚ºæº–ã€‚</li>
                <li>æŠ•è³‡ä¸€å®šæœ‰é¢¨éšªï¼ŒåŸºé‡‘æŠ•è³‡æœ‰è³ºæœ‰è³ ï¼Œç”³è³¼å‰æ‡‰è©³é–±å…¬é–‹èªªæ˜æ›¸ã€‚</li>
                <li>ä½¿ç”¨è€…æ‡‰è‡ªè¡Œè©•ä¼°é¢¨éšªï¼Œæœ¬å·¥å…·é–‹ç™¼è€…ä¸å°ä»»ä½•å¼•ç”¨æœ¬å·¥å…·æ‰€åšå‡ºä¹‹æŠ•è³‡æ±ºç­–è² è²¬ã€‚</li>
            </ol>
        </div>

    </div>

</div>

<script>
    // ==========================================
    // ğŸ”’ è¨­å®šæ‚¨çš„å¯†ç¢¼
    const MY_ACCESS_PASSWORD = "TP927"; 
    // ğŸ–¼ï¸ Banner
    const BANNER_IMAGE_URL = "https://i.postimg.cc/G2JSDD08/Gemini-Generated-Image-7xa57e7xa57e7xa5.png"; 
    // ==========================================

    let isManualMode = false; 

    function checkPassword() {
        const input = document.getElementById('passwordInput').value;
        const overlay = document.getElementById('loginOverlay');
        const errorMsg = document.getElementById('errorMsg');
        
        if (input === MY_ACCESS_PASSWORD) {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        if (BANNER_IMAGE_URL && BANNER_IMAGE_URL.trim() !== "") {
            document.getElementById('bannerImg').src = BANNER_IMAGE_URL;
            document.getElementById('bannerContainer').style.display = 'block';
        }
        autoSetFee();
        checkAutoBalance(); 
    });

    const EXCHANGE_RATE = 31.32;
    let isUSD = false;
    
    // ç¾å¯Œç´…é‹ è§£ç´„é‡‘æ¯”ä¾‹
    const CASH_VALUE_RATIO = [0, 0.38, 0.52, 0.57, 0.65, 0.76, 1.01, 1.04, 1.07, 1.11, 1.14, 1.18, 1.21, 1.24, 1.27, 1.31, 1.34, 1.37, 1.41, 1.44, 1.47];
    
    // ä¿å–®å€Ÿæ¬¾ä¸Šé™æ¯”ä¾‹
    const LOAN_LIMIT_RATIO = [0, 0.70, 0.70, 0.70, 0.75, 0.80, 0.85];

    function getLoanRatio(year) {
        if (year >= 6) return 0.85;
        return LOAN_LIMIT_RATIO[year] || 0.70;
    }

    function adjustValue(id, step) {
        const input = document.getElementById(id);
        let val = parseFloat(input.value) || 0;
        val += step;
        if (id === 'feeRate' && val < 0) val = 0;
        if (id === 'payoutRate' && val < 0) val = 0;
        
        if (step % 1 !== 0) { input.value = val.toFixed(1); } else { input.value = Math.round(val); }
        handleParamChange();
    }

    function adjustPremium(step) {
        enableManualMode();
        const input = document.getElementById('manualPremium');
        let val = parseFloat(input.value) || 0;
        val += step;
        if (val < 0) val = 0;
        input.value = Math.round(val);
        calculatePlan();
    }

    function enableManualMode() {
        if (!isManualMode) {
            isManualMode = true;
            document.getElementById('resetAutoBtn').style.display = 'block';
            document.getElementById('premiumContainer').classList.add('manual-mode');
            document.querySelector("label[for='manualPremium']").innerText = "åˆ†ç´…ä¿å–®å¹´ç¹³ä¿è²» (æ‰‹å‹•é–å®šä¸­)";
        }
    }

    function restoreAutoMode() {
        isManualMode = false;
        document.getElementById('resetAutoBtn').style.display = 'none';
        document.getElementById('premiumContainer').classList.remove('manual-mode');
        document.querySelector("label[for='manualPremium']").innerText = "åˆ†ç´…ä¿å–®å¹´ç¹³ä¿è²» (ç³»çµ±è‡ªå‹•è©¦ç®—)";
        checkAutoBalance(); 
    }

    function formatCurrency(num) {
        if (isNaN(num)) return "0";
        if (isUSD) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } else {
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    }
    
    function toggleCurrency() {
        const toggle = document.getElementById('currencyToggle');
        const label = document.getElementById('currencyText');
        const inputLabel = document.getElementById('inputLabel');
        const inputField = document.getElementById('principal');
        const premiumField = document.getElementById('manualPremium');
        
        let currentVal = parseFloat(inputField.value) || 0;
        let currentPremium = parseFloat(premiumField.value) || 0;

        isUSD = toggle.checked;

        if (isUSD) {
            label.innerText = "USD";
            inputLabel.innerText = "è¼¸å…¥ç¸½è³‡é‡‘è¦æ¨¡ (USD)";
            inputField.value = (currentVal / EXCHANGE_RATE).toFixed(2);
            premiumField.value = (currentPremium / EXCHANGE_RATE).toFixed(0);
        } else {
            label.innerText = "TWD";
            inputLabel.innerText = "è¼¸å…¥ç¸½è³‡é‡‘è¦æ¨¡ (NT$)";
            inputField.value = Math.round(currentVal * EXCHANGE_RATE);
            premiumField.value = Math.round(currentPremium * EXCHANGE_RATE);
        }
        
        autoSetFee();
        if(!isManualMode) { setTimeout(checkAutoBalance, 50); } else { setTimeout(calculatePlan, 50); }
    }

    function autoSetFee() {
        const inputField = document.getElementById('principal');
        let val = parseFloat(inputField.value) || 0;
        let feeInput = document.getElementById('feeRate');
        let investmentTWD = isUSD ? val * EXCHANGE_RATE : val;
        
        let suggestedFee = 5;
        if (investmentTWD >= 10000000) suggestedFee = 2;
        else if (investmentTWD >= 5000000) suggestedFee = 3;
        else if (investmentTWD >= 2000000) suggestedFee = 4;
        
        feeInput.value = suggestedFee;
    }
    
    function handlePrincipalChange() {
        autoSetFee();
        if (!isManualMode) { checkAutoBalance(); } else { calculatePlan(); }
    }

    function handleParamChange() {
        if (!isManualMode) { checkAutoBalance(); } else { calculatePlan(); }
    }

    function checkAutoBalance() {
        if (isManualMode) return; 

        let principal = parseFloat(document.getElementById('principal').value) || 0;
        let rateInput = parseFloat(document.getElementById('payoutRate').value) || 8;
        let feeInput = parseFloat(document.getElementById('feeRate').value) || 2;
        
        const PAYOUT_RATE = rateInput / 100;
        const FEE_RATE = feeInput / 100;
        
        const netRate = (1 - FEE_RATE) * PAYOUT_RATE;
        const suggested = (principal * netRate) / (1 + netRate);
        
        document.getElementById('manualPremium').value = Math.round(suggested);
        calculatePlan(); 
    }

    function generateProjectionTable(investmentBase, annualPremium, totalPrincipal, termYears, startAge, payoutRate) {
        try {
            const tableBody = document.getElementById('projectionBody');
            if(!tableBody) return; 

            let tableHTML = '';
            let cashFlowAccumulated = 0; 

            for (let year = 1; year <= 20; year++) {
                let currentAge = startAge + year; 
                
                let accumulatedPremiums = (year <= termYears) ? annualPremium * year : annualPremium * termYears;
                let ratio = CASH_VALUE_RATIO[year] || 1.47; 
                let surrenderValue = accumulatedPremiums * ratio;

                let investPayout = investmentBase * payoutRate;
                let currentInvestment = investmentBase; 
                
                let investmentReserve = currentInvestment * 0.5;
                let loanLimitPercent = getLoanRatio(year);
                let policyReserve = surrenderValue * loanLimitPercent;

                let investPayoutDisplay = formatCurrency(investPayout);
                let investPayoutClass = "val-invest-payout";
                
                let totalAsset = 0;

                if (year > termYears) {
                    cashFlowAccumulated += investPayout;
                    totalAsset = surrenderValue + currentInvestment + cashFlowAccumulated;
                    
                    investPayoutClass = "val-invest-payout cashflow-highlight";
                    investPayoutDisplay = `${formatCurrency(investPayout)}<span class="cashflow-label">(ç¾é‡‘æµ)</span>`;
                } else {
                    totalAsset = surrenderValue + currentInvestment;
                }

                let totalRoiRatio = (totalPrincipal > 0) ? (totalAsset / totalPrincipal) * 100 : 0;

                tableHTML += `
                    <tr>
                        <td class="td-year">ç¬¬ ${year} å¹´</td>
                        <td>${currentAge} æ­²</td>
                        <td class="val-surrender">${formatCurrency(surrenderValue)}</td>
                        <td class="${investPayoutClass}">${investPayoutDisplay}</td>
                        <td>${formatCurrency(currentInvestment)}</td>
                        <td>${formatCurrency(investmentReserve)}</td>
                        <td>${formatCurrency(policyReserve)}</td>
                        <td class="val-total">${formatCurrency(totalAsset)}</td>
                        <td class="col-roi">${totalRoiRatio.toFixed(1)}%</td>
                    </tr>
                `;
            }
            tableBody.innerHTML = tableHTML;
            document.getElementById('projectionArea').style.display = 'block';
        } catch (e) { console.error(e); }
    }

    function calculatePlan() {
        try {
            let rateInput = parseFloat(document.getElementById('payoutRate').value);
            let feeInput = parseFloat(document.getElementById('feeRate').value);
            let ageInput = parseInt(document.getElementById('clientAge').value);
            let principalAmount = parseFloat(document.getElementById('principal').value);
            let annualSavingsPremium = parseFloat(document.getElementById('manualPremium').value);
            
            if (isNaN(rateInput) || rateInput <= 0) rateInput = 8;
            if (isNaN(feeInput) || feeInput < 0) feeInput = 0;
            if (isNaN(ageInput) || ageInput < 0) ageInput = 36;
            if (isNaN(principalAmount) || principalAmount <= 0) return;
            if (isNaN(annualSavingsPremium)) annualSavingsPremium = 0;

            const PAYOUT_RATE = rateInput / 100;
            const FEE_RATE = feeInput / 100;
            const TERM_YEARS = 6;

            const investmentPreFee = principalAmount - annualSavingsPremium;
            
            if (investmentPreFee < 0) {
                document.getElementById('results').innerHTML = '<p style="color:red;text-align:center;">ä¿è²»è¨­å®šéé«˜ï¼Œè¶…éç¸½è³‡é‡‘ï¼</p>';
                return;
            }

            const totalFee = investmentPreFee * FEE_RATE;
            const investmentBase = investmentPreFee - totalFee; 
            const annualPayout = investmentBase * PAYOUT_RATE; 
            
            const totalSavingsPaid = annualSavingsPremium * TERM_YEARS;
            const surrenderValueY6 = (annualSavingsPremium * TERM_YEARS) * CASH_VALUE_RATIO[6];
            const totalAssetAfterSixYears = surrenderValueY6 + investmentBase; 
            
            const balance = annualPayout - annualSavingsPremium;
            const tolerance = isUSD ? 1 : 10; 
            let validationStatus = '';
            
            if (balance >= -tolerance) {
                validationStatus = `<span class="status-badge status-success">å……è¶³ (é¤˜ ${formatCurrency(balance)})</span>`;
            } else {
                validationStatus = `<span class="status-badge status-error">ä¸è¶³ (ç¼º ${formatCurrency(Math.abs(balance))})</span>`;
            }

            const symbol = isUSD ? "USD " : "NT$ ";

            const resultsHTML = `
                <h3 class="section-title">åˆ†ç´…ä¿å–®é…ç½® ${isManualMode ? '(æ‰‹å‹•)' : '(è‡ªå‹•)'}</h3>
                <div class="result-row">
                    <span class="result-label">å¹´ç¹³ä¿è²»</span>
                    <span class="result-value" style="color:var(--accent-color); font-size:1.1em;">${symbol}${formatCurrency(annualSavingsPremium)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">å…­å¹´ç¸½æŠ•å…¥ä¿è²»</span>
                    <span class="result-value">${symbol}${formatCurrency(totalSavingsPaid)}</span>
                </div>
                
                <h3 class="section-title">æŠ•è³‡å‹ä¿å–®é…ç½®</h3>
                <div class="result-row">
                    <span class="result-label">å‰©é¤˜è³‡é‡‘è½‰å…¥æŠ•è³‡</span>
                    <span class="result-value">${symbol}${formatCurrency(investmentPreFee)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">å¯¦éš›é€²å ´æœ¬é‡‘ (æ‰£é™¤æ‰‹çºŒè²»)</span>
                    <span class="result-value highlight-blue">${symbol}${formatCurrency(investmentBase)}</span>
                </div>
                
                <h3 class="section-title">ç¾é‡‘æµæª¢è¦–</h3>
                <div class="result-row">
                    <span class="result-label">é æœŸå¹´åŒ–é…æ¯ (${rateInput}%)</span>
                    <span class="result-value" style="color:var(--success-green);">${symbol}${formatCurrency(annualPayout)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">é…æ¯è¦†è“‹ä¿è²»</span>
                    <span class="result-value">${validationStatus}</span>
                </div>
                
                <div class="highlight-total-card">
                    <span class="result-label">å…­å¹´å¾Œç¸½è³‡ç”¢é ä¼° (ä¸å«é…æ¯)</span>
                    <span class="result-value">${symbol}${formatCurrency(totalAssetAfterSixYears)}</span>
                </div>
            `;
            
            document.getElementById('results').innerHTML = resultsHTML;
            generateProjectionTable(investmentBase, annualSavingsPremium, principalAmount, TERM_YEARS, ageInput, PAYOUT_RATE);
        } catch(e) { console.error("è¨ˆç®—éŒ¯èª¤:", e); }
    }
</script>

</body>
</html>
